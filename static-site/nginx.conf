user  nginx;
worker_processes  auto;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Rate limiting zone - 10MB can track ~160k IP addresses
    # Limit: 10 requests per second per IP, burst of 20
    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;

    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name _;
        root /usr/share/nginx/html;
        index index.html;

        # SSL configuration (mounted read-only)
        ssl_certificate /etc/nginx/certs/cert.pem;
        ssl_certificate_key /etc/nginx/certs/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # keep temp files off read-only paths
        client_body_temp_path /tmp/client_temp;

        # Apply rate limiting globally
        limit_req zone=general burst=20 nodelay;

        # Client request limits (prevent large uploads/DoS)
        client_max_body_size 1m;
        client_body_buffer_size 16k;
        client_header_buffer_size 1k;
        large_client_header_buffers 4 8k;

        # security headers
        add_header Content-Security-Policy "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self'; form-action 'self' https://formspree.io; connect-src 'self'; object-src 'none'; base-uri 'none'; frame-ancestors 'none'; upgrade-insecure-requests" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "same-origin" always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # Hide nginx version
        server_tokens off;

        # cache immutable assets
        location ~* \.(?:css|js)$ {
            add_header Cache-Control "public, max-age=31536000, immutable";
            try_files $uri =404;
        }
        location ~* \.(?:png|jpe?g|gif|svg|ico|webp|avif)$ {
            add_header Cache-Control "public, max-age=31536000, immutable";
            try_files $uri =404;
        }

        # default route
        location / {
            try_files $uri $uri/ =404;
        }

        error_page 404 /404.html;
        location = /404.html { internal; }
    }
}
